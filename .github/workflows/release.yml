---
name: release

on:

  workflow_call:
    inputs:
      modules:
        type: string
        required: true
        description: |
          JSON array of modules to release
      dry-run:
        type: boolean
        required: false
        default: false
        description: Whether to perform a dry run (no tags or releases will be created)

concurrency:
  group: ${{ github.ref }}-release
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:

  tag-and-release:
    runs-on: ubuntu-latest
    if: ${{ inputs.modules != '[]' && inputs.modules != '' }}
    strategy:
      matrix:
        module: ${{ fromJson(inputs.modules) }}
    steps:
      -
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      -
        name: Output tag prefix
        id: tag-prefix
        run: |
          echo "prefix=${{ matrix.module }}/v" | tee -a "$GITHUB_OUTPUT"
      -
        name: Parse version from package.json
        id: parse-version
        env:
          TAG_PREFIX: ${{ steps.tag-prefix.outputs.prefix }}
        run: |
          VERSION=$(cat "${{ matrix.module }}/package.json" | jq -rc '.version')
          VERSION=${VERSION##v}
          echo "version=$VERSION" | tee -a "$GITHUB_OUTPUT"

          TAG="${TAG_PREFIX}${VERSION}"
          echo "version-tag=$TAG" | tee -a "$GITHUB_OUTPUT"
      -
        name: Parse first line of commit message
        id: release-body
        run: |
          FIRST_LINE=$(git log --format=%B -n 1 HEAD | head -n 1)
          echo "body=$FIRST_LINE" | tee -a "$GITHUB_OUTPUT"
      -
        name: Setup git config
        if: ${{ inputs.dry-run == false }}
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      -
        name: Create tag for current HEAD
        if: ${{ inputs.dry-run == false }}
        env:
          NEXT_TAG: ${{ steps.parse-version.outputs.version-tag }}
        run: |
          git tag $NEXT_TAG
          git push origin $NEXT_TAG
      -
        name: Create GitHub release
        if: ${{ inputs.dry-run == false }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.parse-version.outputs.version-tag }}
          body: ${{ steps.release-body.outputs.body }}
